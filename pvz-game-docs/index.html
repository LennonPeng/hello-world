<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê§çÁâ©Â§ßÊàòÂÉµÂ∞∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
        }
        
        h1 {
            color: #4CAF50;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        #game-container {
            position: relative;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 15%, #228B22 15%, #228B22 100%);
            border: 4px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #gameCanvas {
            display: block;
        }
        
        #ui-panel {
            display: flex;
            gap: 20px;
            padding: 15px 30px;
            background: linear-gradient(to bottom, #444, #333);
            border-radius: 0 0 8px 8px;
            align-items: center;
        }
        
        .stat {
            color: white;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sun-icon {
            color: #FFD700;
            font-size: 24px;
        }
        
        #plant-cards {
            display: flex;
            gap: 10px;
        }
        
        .plant-card {
            width: 70px;
            height: 80px;
            background: linear-gradient(to bottom, #666, #444);
            border: 3px solid #888;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
            transition: all 0.2s;
            position: relative;
        }
        
        .plant-card:hover {
            transform: scale(1.05);
            border-color: #FFD700;
        }
        
        .plant-card.selected {
            border-color: #FFD700;
            box-shadow: 0 0 15px #FFD700;
        }
        
        .plant-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .plant-icon {
            font-size: 32px;
        }
        
        .plant-cost {
            color: #FFD700;
            font-size: 14px;
            font-weight: bold;
        }
        
        .plant-key {
            position: absolute;
            top: -10px;
            left: -5px;
            background: #333;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        #start-btn {
            padding: 10px 30px;
            font-size: 18px;
            background: linear-gradient(to bottom, #4CAF50, #388E3C);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #start-btn:hover {
            background: linear-gradient(to bottom, #66BB6A, #4CAF50);
            transform: scale(1.05);
        }
        
        #instructions {
            color: #aaa;
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
        }
        
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        #game-over h2 {
            font-size: 48px;
            color: #f44336;
            margin-bottom: 20px;
        }
        
        #restart-btn {
            padding: 15px 40px;
            font-size: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>üåª Ê§çÁâ©Â§ßÊàòÂÉµÂ∞∏ üåª</h1>
    
    <div id="game-container">
        <canvas id="gameCanvas" width="900" height="500"></canvas>
        
        <div id="game-over">
            <h2>GAME OVER</h2>
            <p id="final-score" style="font-size: 24px; margin-bottom: 20px;"></p>
            <button id="restart-btn" onclick="restartGame()">ÈáçÊñ∞ÂºÄÂßã</button>
        </div>
    </div>
    
    <div id="ui-panel">
        <div class="stat">
            <span class="sun-icon">‚òÄ</span>
            <span id="sun-display">150</span>
        </div>
        
        <div class="stat">
            <span>üåä</span>
            <span>Ê≥¢Ê¨°: <span id="wave-display">1</span></span>
        </div>
        
        <div class="stat">
            <span>‚≠ê</span>
            <span>ÂàÜÊï∞: <span id="score-display">0</span></span>
        </div>
        
        <div id="plant-cards">
            <div class="plant-card" data-plant="peashooter" data-cost="100" onclick="selectPlant(0)">
                <span class="plant-key">1</span>
                <span class="plant-icon">üü¢</span>
                <span class="plant-cost">100</span>
            </div>
            <div class="plant-card" data-plant="sunflower" data-cost="50" onclick="selectPlant(1)">
                <span class="plant-key">2</span>
                <span class="plant-icon">üåª</span>
                <span class="plant-cost">50</span>
            </div>
            <div class="plant-card" data-plant="wallnut" data-cost="50" onclick="selectPlant(2)">
                <span class="plant-key">3</span>
                <span class="plant-icon">ü•ú</span>
                <span class="plant-cost">50</span>
            </div>
            <div class="plant-card" data-plant="snowpea" data-cost="175" onclick="selectPlant(3)">
                <span class="plant-key">4</span>
                <span class="plant-icon">üßä</span>
                <span class="plant-cost">175</span>
            </div>
            <div class="plant-card" data-plant="cherrybomb" data-cost="150" onclick="selectPlant(4)">
                <span class="plant-key">5</span>
                <span class="plant-icon">üçí</span>
                <span class="plant-cost">150</span>
            </div>
        </div>
    </div>
    
    <div id="instructions">
        <p>üñ±Ô∏è ÁÇπÂáªÂç°ÁâáÈÄâÊã©Ê§çÁâ© ‚Üí ÁÇπÂáªËçâÂú∞ÊîæÁΩÆ | ‚òÄÔ∏è ÁÇπÂáªÈò≥ÂÖâÊî∂ÈõÜ | Êï∞Â≠óÈîÆ1-5Âø´ÈÄüÈÄâÊã©</p>
    </div>

    <script>
        // ========== Ê∏∏ÊàèÈÖçÁΩÆ ==========
        const CANVAS_WIDTH = 900;
        const CANVAS_HEIGHT = 500;
        const GRID_SIZE = 100;
        const GRID_COLS = 9;
        const GRID_ROWS = 4;
        
        const PLANTS_DATA = {
            peashooter: { cost: 100, hp: 100, color: '#4CAF50', emoji: 'üü¢', cooldown: 1500 },
            sunflower: { cost: 50, hp: 80, color: '#FFD700', emoji: 'üåª', cooldown: 5000 },
            wallnut: { cost: 50, hp: 400, color: '#8B4513', emoji: 'ü•ú', cooldown: 0 },
            snowpea: { cost: 175, hp: 100, color: '#03A9F4', emoji: 'üßä', cooldown: 1500 },
            cherrybomb: { cost: 150, hp: 1, color: '#f44336', emoji: 'üçí', cooldown: 0 }
        };
        
        // ========== Ê∏∏ÊàèÁä∂ÊÄÅ ==========
        let canvas, ctx;
        let gameState = {
            sun: 150,
            score: 0,
            wave: 1,
            plants: [],
            zombies: [],
            peas: [],
            suns: [],
            explosions: [],
            selectedPlant: null,
            gameOver: false,
            lastTime: 0,
            zombieSpawnTimer: 0,
            zombiesToSpawn: 0,
            grid: []
        };
        
        // ========== ÂàùÂßãÂåñ ==========
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // ÂàùÂßãÂåñÁΩëÊ†º
            for (let row = 0; row < GRID_ROWS; row++) {
                gameState.grid[row] = [];
                for (let col = 0; col < GRID_COLS; col++) {
                    gameState.grid[row][col] = null;
                }
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                gameState.selectedPlant = null;
                updateCardSelection();
            });
            
            document.addEventListener('keydown', handleKeyDown);
            
            // ÂºÄÂßãÊ∏∏Êàè
            startWave();
            requestAnimationFrame(gameLoop);
        }
        
        function startWave() {
            gameState.zombiesToSpawn = 3 + gameState.wave * 2;
        }
        
        // ========== Ê∏∏ÊàèÂæ™ÁéØ ==========
        function gameLoop(timestamp) {
            if (gameState.gameOver) return;
            
            const deltaTime = timestamp - gameState.lastTime;
            gameState.lastTime = timestamp;
            
            update(deltaTime);
            render();
            
            requestAnimationFrame(gameLoop);
        }
        
        function update(deltaTime) {
            // ÁîüÊàêÂÉµÂ∞∏
            if (gameState.zombiesToSpawn > 0) {
                gameState.zombieSpawnTimer += deltaTime;
                if (gameState.zombieSpawnTimer >= 3000) {
                    spawnZombie();
                    gameState.zombieSpawnTimer = 0;
                }
            } else if (gameState.zombies.length === 0) {
                // Ê≥¢Ê¨°ÂÆåÊàê
                gameState.wave++;
                document.getElementById('wave-display').textContent = gameState.wave;
                startWave();
            }
            
            // Êõ¥Êñ∞Ê§çÁâ©
            gameState.plants.forEach(plant => {
                plant.update(deltaTime);
            });
            
            // Êõ¥Êñ∞ÂÉµÂ∞∏
            gameState.zombies.forEach((zombie, index) => {
                zombie.update(deltaTime);
                
                // Ê£ÄÊµãÊ§çÁâ©Á¢∞Êíû
                gameState.plants.forEach(plant => {
                    if (plant.row === zombie.row && 
                        Math.abs(zombie.x - plant.x) < 30) {
                        zombie.eating = true;
                        plant.hp -= zombie.damage * deltaTime / 1000;
                    }
                });
                
                // Âà∞ËææÂ∑¶‰æß
                if (zombie.x < -30) {
                    gameOver();
                }
            });
            
            // ÁßªÈô§Ê≠ª‰∫°Ê§çÁâ©
            gameState.plants = gameState.plants.filter(plant => {
                if (plant.hp <= 0) {
                    gameState.grid[plant.row][plant.col] = null;
                    return false;
                }
                return true;
            });
            
            // ÁßªÈô§Ê≠ª‰∫°ÂÉµÂ∞∏
            gameState.zombies = gameState.zombies.filter(zombie => {
                if (zombie.hp <= 0) {
                    gameState.score += 10;
                    document.getElementById('score-display').textContent = gameState.score;
                    return false;
                }
                return true;
            });
            
            // Êõ¥Êñ∞Ë±åË±Ü
            gameState.peas.forEach(pea => {
                pea.update();
                
                // Á¢∞ÊíûÊ£ÄÊµã
                gameState.zombies.forEach(zombie => {
                    if (Math.abs(pea.x - zombie.x) < 25 && 
                        Math.abs(pea.y - (zombie.row * GRID_SIZE + GRID_SIZE/2)) < 30) {
                        zombie.hp -= pea.damage;
                        pea.hit = true;
                        if (pea.frozen) {
                            zombie.frozen = true;
                            zombie.frozenTimer = 5000;
                        }
                    }
                });
            });
            
            // ÁßªÈô§Âáª‰∏≠ÊàñÂá∫Â±èÁöÑË±åË±Ü
            gameState.peas = gameState.peas.filter(pea => !pea.hit && pea.x < CANVAS_WIDTH);
            
            // Êõ¥Êñ∞Èò≥ÂÖâ
            gameState.suns.forEach(sun => {
                sun.update();
            });
            
            // ÁßªÈô§Êî∂ÈõÜÁöÑÈò≥ÂÖâ
            gameState.suns = gameState.suns.filter(sun => !sun.collected);
            
            // Êõ¥Êñ∞ÁàÜÁÇ∏
            gameState.explosions.forEach(exp => {
                exp.update();
                
                // ‰º§ÂÆ≥ÂÉµÂ∞∏
                gameState.zombies.forEach(zombie => {
                    const dx = zombie.x - exp.x;
                    const dy = zombie.row * GRID_SIZE + GRID_SIZE/2 - exp.y;
                    if (Math.sqrt(dx*dx + dy*dy) < exp.radius) {
                        zombie.hp -= exp.damage * deltaTime / 100;
                    }
                });
            });
            
            gameState.explosions = gameState.explosions.filter(exp => !exp.done);
            
            // Êõ¥Êñ∞Âç°ÁâáÁä∂ÊÄÅ
            updateCardStates();
        }
        
        function render() {
            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            // ÁªòÂà∂ËÉåÊôØ
            // Â§©Á©∫
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT * 0.15);
            
            // ËçâÂú∞
            ctx.fillStyle = '#228B22';
            ctx.fillRect(0, CANVAS_HEIGHT * 0.15, CANVAS_WIDTH, CANVAS_HEIGHT * 0.85);
            
            // ÁªòÂà∂ÁΩëÊ†º
            for (let row = 0; row < GRID_ROWS; row++) {
                for (let col = 0; col < GRID_COLS; col++) {
                    ctx.strokeStyle = 'rgba(0,0,0,0.2)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(col * GRID_SIZE, CANVAS_HEIGHT * 0.15 + row * GRID_SIZE, GRID_SIZE, GRID_SIZE);
                }
            }
            
            // ÁªòÂà∂Ê§çÁâ©
            gameState.plants.forEach(plant => plant.render(ctx));
            
            // ÁªòÂà∂ÂÉµÂ∞∏
            gameState.zombies.forEach(zombie => zombie.render(ctx));
            
            // ÁªòÂà∂Ë±åË±Ü
            gameState.peas.forEach(pea => pea.render(ctx));
            
            // ÁªòÂà∂Èò≥ÂÖâ
            gameState.suns.forEach(sun => sun.render(ctx));
            
            // ÁªòÂà∂ÁàÜÁÇ∏
            gameState.explosions.forEach(exp => exp.render(ctx));
            
            // ÁªòÂà∂ÈÄâ‰∏≠‰ΩçÁΩÆ
            if (gameState.selectedPlant) {
                // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†È¢ÑËßàÊïàÊûú
            }
        }
        
        // ========== Ê§çÁâ©Á±ª ==========
        class Plant {
            constructor(type, col, row) {
                this.type = type;
                this.col = col;
                this.row = row;
                this.x = col * GRID_SIZE + GRID_SIZE / 2;
                this.y = CANVAS_HEIGHT * 0.15 + row * GRID_SIZE + GRID_SIZE / 2;
                
                const data = PLANTS_DATA[type];
                this.hp = data.hp;
                this.maxHp = data.hp;
                this.cooldown = data.cooldown;
                this.lastAction = 0;
            }
            
            update(deltaTime) {
                const now = performance.now();
                
                if (this.type === 'peashooter' || this.type === 'snowpea') {
                    // Ê£ÄÊü•Âêå‰∏ÄË°åÊòØÂê¶ÊúâÂÉµÂ∞∏
                    const hasZombie = gameState.zombies.some(z => z.row === this.row && z.x > this.x);
                    
                    if (hasZombie && now - this.lastAction >= this.cooldown) {
                        this.shoot();
                        this.lastAction = now;
                    }
                } else if (this.type === 'sunflower') {
                    if (now - this.lastAction >= this.cooldown) {
                        this.produce();
                        this.lastAction = now;
                    }
                } else if (this.type === 'cherrybomb') {
                    // Á´ãÂç≥ÁàÜÁÇ∏
                    createExplosion(this.x, this.y);
                    gameState.grid[this.row][this.col] = null;
                    const index = gameState.plants.indexOf(this);
                    if (index > -1) gameState.plants.splice(index, 1);
                }
            }
            
            shoot() {
                const type = this.type === 'snowpea' ? 'ice' : 'normal';
                gameState.peas.push(new Pea(this.x + 30, this.y, type));
            }
            
            produce() {
                gameState.suns.push(new Sun(this.x, this.y - 20, false));
            }
            
            render(ctx) {
                const data = PLANTS_DATA[this.type];
                
                // Ê§çÁâ©Ë∫´‰Ωì
                ctx.font = '40px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(data.emoji, this.x, this.y);
                
                // Ë°ÄÊù°
                const hpRatio = this.hp / this.maxHp;
                const barWidth = 60;
                ctx.fillStyle = '#333';
                ctx.fillRect(this.x - barWidth/2, this.y - 35, barWidth, 6);
                ctx.fillStyle = hpRatio > 0.5 ? '#4CAF50' : hpRatio > 0.25 ? '#FF9800' : '#f44336';
                ctx.fillRect(this.x - barWidth/2, this.y - 35, barWidth * hpRatio, 6);
            }
        }
        
        // ========== ÂÉµÂ∞∏Á±ª ==========
        class Zombie {
            constructor(row) {
                this.row = row;
                this.x = CANVAS_WIDTH + 50;
                this.y = CANVAS_HEIGHT * 0.15 + row * GRID_SIZE + 10;
                
                const rand = Math.random();
                if (rand < 0.7) {
                    this.hp = 100;
                    this.speed = 0.8;
                    this.emoji = 'üßü';
                } else if (rand < 0.9) {
                    this.hp = 200;
                    this.speed = 0.6;
                    this.emoji = 'üßü‚Äç‚ôÇÔ∏è';
                } else {
                    this.hp = 400;
                    this.speed = 0.4;
                    this.emoji = 'üßô';
                }
                
                this.maxHp = this.hp;
                this.damage = 20;
                this.eating = false;
                this.frozen = false;
                this.frozenTimer = 0;
            }
            
            update(deltaTime) {
                if (!this.eating) {
                    const speed = this.frozen ? this.speed * 0.5 : this.speed;
                    this.x -= speed * deltaTime / 16;
                }
                
                if (this.frozen) {
                    this.frozenTimer -= deltaTime;
                    if (this.frozenTimer <= 0) {
                        this.frozen = false;
                    }
                }
            }
            
            render(ctx) {
                // ÁªòÂà∂ÂÉµÂ∞∏
                ctx.font = '45px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                if (this.frozen) {
                    ctx.globalAlpha = 0.7;
                }
                ctx.fillText(this.emoji, this.x, this.y + 15);
                ctx.globalAlpha = 1;
                
                // Ë°ÄÊù°
                const hpRatio = this.hp / this.maxHp;
                const barWidth = 50;
                ctx.fillStyle = '#333';
                ctx.fillRect(this.x - barWidth/2, this.y - 20, barWidth, 5);
                ctx.fillStyle = hpRatio > 0.5 ? '#4CAF50' : '#f44336';
                ctx.fillRect(this.x - barWidth/2, this.y - 20, barWidth * hpRatio, 5);
            }
        }
        
        // ========== Ë±åË±ÜÁ±ª ==========
        class Pea {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.speed = 6;
                this.damage = 20;
                this.hit = false;
            }
            
            update() {
                this.x += this.speed;
            }
            
            render(ctx) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = this.type === 'ice' ? '#80DEEA' : '#4CAF50';
                ctx.fill();
                ctx.strokeStyle = '#2E7D32';
                ctx.stroke();
            }
        }
        
        // ========== Èò≥ÂÖâÁ±ª ==========
        class Sun {
            constructor(x, y, falling = true) {
                this.x = x;
                this.y = y;
                this.targetY = y;
                this.falling = falling;
                this.flying = false;
                this.collected = false;
                this.size = 40;
                
                if (falling) {
                    this.targetY = CANVAS_HEIGHT * 0.15 + Math.floor(Math.random() * 4) * GRID_SIZE + 50;
                }
            }
            
            update() {
                if (this.falling && this.y < this.targetY) {
                    this.y += 2;
                } else if (this.falling) {
                    this.falling = false;
                }
                
                if (this.flying) {
                    const dx = 80 - this.x;
                    const dy = 50 - this.y;
                    this.x += dx * 0.1;
                    this.y += dy * 0.1;
                    
                    if (Math.abs(dx) < 5 && Math.abs(dy) < 5) {
                        this.collected = true;
                        gameState.sun += 25;
                        updateSunDisplay();
                    }
                }
            }
            
            render(ctx) {
                // Èò≥ÂÖâÂÖâËäí
                ctx.fillStyle = '#FFD700';
                for (let i = 0; i < 8; i++) {
                    const angle = (i * 45 + performance.now() / 50) * Math.PI / 180;
                    const x2 = this.x + 25 * Math.cos(angle);
                    const y2 = this.y + 25 * Math.sin(angle);
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(x2, y2);
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
                
                // Èò≥ÂÖâ‰∏≠ÂøÉ
                ctx.beginPath();
                ctx.arc(this.x, this.y, 15, 0, Math.PI * 2);
                ctx.fillStyle = '#FFD700';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(this.x, this.y, 10, 0, Math.PI * 2);
                ctx.fillStyle = '#FFF59D';
                ctx.fill();
            }
        }
        
        // ========== ÁàÜÁÇ∏Á±ª ==========
        class Explosion {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = 10;
                this.maxRadius = 150;
                this.expanding = true;
                this.damage = 1800;
                this.done = false;
            }
            
            update() {
                if (this.expanding) {
                    this.radius += 10;
                    if (this.radius >= this.maxRadius) {
                        this.expanding = false;
                    }
                } else {
                    this.radius -= 10;
                    if (this.radius <= 0) {
                        this.done = true;
                    }
                }
            }
            
            render(ctx) {
                const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius);
                gradient.addColorStop(0, 'rgba(255, 200, 0, 0.8)');
                gradient.addColorStop(0.5, 'rgba(255, 100, 0, 0.5)');
                gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
                
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
            }
        }
        
        function createExplosion(x, y) {
            gameState.explosions.push(new Explosion(x, y));
        }
        
        function spawnZombie() {
            const row = Math.floor(Math.random() * GRID_ROWS);
            gameState.zombies.push(new Zombie(row));
            gameState.zombiesToSpawn--;
        }
        
        // ========== Áî®Êà∑‰∫§‰∫í ==========
        function selectPlant(index) {
            const cards = document.querySelectorAll('.plant-card');
            const card = cards[index];
            const cost = parseInt(card.dataset.cost);
            
            if (gameState.sun >= cost) {
                gameState.selectedPlant = {
                    type: card.dataset.plant,
                    cost: cost
                };
                updateCardSelection();
            }
        }
        
        function updateCardSelection() {
            const cards = document.querySelectorAll('.plant-card');
            cards.forEach(card => card.classList.remove('selected'));
            
            if (gameState.selectedPlant) {
                const index = ['peashooter', 'sunflower', 'wallnut', 'snowpea', 'cherrybomb'].indexOf(gameState.selectedPlant.type);
                cards[index].classList.add('selected');
            }
        }
        
        function updateCardStates() {
            const cards = document.querySelectorAll('.plant-card');
            cards.forEach(card => {
                const cost = parseInt(card.dataset.cost);
                if (gameState.sun < cost) {
                    card.classList.add('disabled');
                } else {
                    card.classList.remove('disabled');
                }
            });
        }
        
        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáªÈò≥ÂÖâ
            for (const sun of gameState.suns) {
                if (!sun.flying) {
                    const dx = x - sun.x;
                    const dy = y - sun.y;
                    if (Math.sqrt(dx*dx + dy*dy) < 30) {
                        sun.flying = true;
                        return;
                    }
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáªÁΩëÊ†ºÊîæÁΩÆÊ§çÁâ©
            if (y > CANVAS_HEIGHT * 0.15) {
                const col = Math.floor(x / GRID_SIZE);
                const row = Math.floor((y - CANVAS_HEIGHT * 0.15) / GRID_SIZE);
                
                if (col >= 0 && col < GRID_COLS && row >= 0 && row < GRID_ROWS) {
                    if (!gameState.grid[row][col] && gameState.selectedPlant) {
                        // Ê£ÄÊü•Ëä±Ë¥π
                        if (gameState.sun >= gameState.selectedPlant.cost) {
                            // ÊîæÁΩÆÊ§çÁâ©
                            const plant = new Plant(gameState.selectedPlant.type, col, row);
                            gameState.plants.push(plant);
                            gameState.grid[row][col] = plant;
                            
                            // Êâ£Èô§Èò≥ÂÖâ
                            gameState.sun -= gameState.selectedPlant.cost;
                            updateSunDisplay();
                            
                            // ÂèñÊ∂àÈÄâÊã©
                            gameState.selectedPlant = null;
                            updateCardSelection();
                        }
                    }
                }
            }
        }
        
        function handleKeyDown(e) {
            const keyMap = {'1': 0, '2': 1, '3': 2, '4': 3, '5': 4};
            if (keyMap[e.key] !== undefined) {
                selectPlant(keyMap[e.key]);
            } else if (e.key === 'Escape') {
                gameState.selectedPlant = null;
                updateCardSelection();
            }
        }
        
        function updateSunDisplay() {
            document.getElementById('sun-display').textContent = gameState.sun;
        }
        
        function gameOver() {
            gameState.gameOver = true;
            document.getElementById('game-over').style.display = 'flex';
            document.getElementById('final-score').textContent = `ÊúÄÁªàÂàÜÊï∞: ${gameState.score}`;
        }
        
        function restartGame() {
            // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
            gameState = {
                sun: 150,
                score: 0,
                wave: 1,
                plants: [],
                zombies: [],
                peas: [],
                suns: [],
                explosions: [],
                selectedPlant: null,
                gameOver: false,
                lastTime: performance.now(),
                zombieSpawnTimer: 0,
                zombiesToSpawn: 0,
                grid: []
            };
            
            for (let row = 0; row < GRID_ROWS; row++) {
                gameState.grid[row] = [];
                for (let col = 0; col < GRID_COLS; col++) {
                    gameState.grid[row][col] = null;
                }
            }
            
            document.getElementById('sun-display').textContent = '150';
            document.getElementById('score-display').textContent = '0';
            document.getElementById('wave-display').textContent = '1';
            document.getElementById('game-over').style.display = 'none';
            
            startWave();
            requestAnimationFrame(gameLoop);
        }
        
        // ÂêØÂä®Ê∏∏Êàè
        window.onload = init;
    </script>
</body>
</html>
